<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Detail Sesi Mata Kuliah</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Poppins', sans-serif; background: #f6f9fb; margin:0; padding: 0 0 80px 0;}
    .container { max-width: 760px; margin: 32px auto 0 auto; background: #fff; padding: 1.5rem; border-radius: 18px; box-shadow: 0 4px 20px rgba(0,0,0,0.06);}
    h2 { background: #3498db; color: #fff; text-align: center; font-weight: 600; font-size: 1.7em; border-radius: 12px 12px 0 0; margin: -1.5rem -1.5rem 2.2rem -1.5rem; padding: 1.3rem 0 0.8rem 0;}
    .back-btn { margin-bottom: 18px; background: #bdbdbd; padding: 7px 22px; border: none; border-radius: 8px; font-size: 1em; cursor: pointer;}
    .info-box { background: #e3f2fd; border-radius: 7px; padding: 16px; margin-bottom: 28px; font-size: 1.07em;}
    .sesi-detail-blok { border: 2px solid #2196f3; background: #f2fafe; border-radius: 9px; margin: 20px 0 12px 0; padding: 1.1rem 1rem 0.7rem 1rem; }
    .soal-blok, .jawaban-blok {margin: 10px 0 15px 0;}
    .detail-label { font-weight: 600; color: #2175bb; min-width:90px; display:inline-block;}
    .doc-link { color: #1976d2; text-decoration: underline; margin-right: 8px; cursor: pointer;}
    .note-link { color: #1976d2; text-decoration: underline;}
    .ocr-block { background: #faf5e6; border-radius: 7px; padding: 11px; margin: 8px 0 0 0; color: #222; font-size:1em; position:relative;}
    .ocr-min { max-height: 45px; overflow: hidden; white-space: pre-line;}
    .expand-btn { color: #1976d2; cursor: pointer; font-size: 0.97em; margin-left: 12px;}
    .expand-btn:hover { text-decoration: underline;}
    .ocr-block-inner { display: inline; }
    @media (max-width:700px){
      .container{max-width:98vw;padding:0.3rem;}
      h2{font-size:1.05em;}
      .info-box{font-size:0.97em;}
    }
    footer { position: fixed; bottom: 0; width: 100%; background: #fff; box-shadow: 0 -1px 6px rgba(0,0,0,0.07); display: flex; justify-content: space-around; padding: 10px 0; z-index: 100;}
    footer a { text-decoration: none; color: #3498db; font-size: 14px; text-align: center;}
  </style>
</head>
<body>
  <div class="container">
    <button class="back-btn" onclick="history.back()">‚Üê Kembali</button>
    <h2>Detail Sesi Mata Kuliah</h2>
    <div id="infoMatkul"></div>
    <div id="detailSesi"></div>
  </div>
  <div id="popup-preview" class="preview-popup" onclick="closePreview(event)">
    <div class="preview-popup-inner" onclick="event.stopPropagation()">
      <button class="close-preview" onclick="closePreview(event)">√ó</button>
      <div id="popup-inner"></div>
    </div>
  </div>
  <footer>
    <a href="dashboard.html">üè†<br>Beranda</a>
    <a href="semester.html">üéì<br>Semester</a>
    <a href="arsip.html">üìö<br>Arsip</a>
    <a href="profil.html">üë§<br>Profil</a>
    <a href="login.html" onclick="localStorage.clear()">üö™<br>Log Out</a>
  </footer>
<script>
const user = JSON.parse(localStorage.getItem('user'));
if (!user || !user._id) window.location = 'login.html';
const urlParams = new URLSearchParams(window.location.search);
const matkulId = urlParams.get('matkul_id');
const sesiId = urlParams.get('sesi_id');

function popupPreview(filePath) {
  const popup = document.getElementById('popup-preview');
  const popupInner = document.getElementById('popup-inner');
  const url = filePath.startsWith('http') ? filePath : `https://ediska-backend.onrender.com/${filePath}`;
  popupInner.innerHTML = '';
  if (/\.(jpg|jpeg|png|gif)$/i.test(url)) {
    popupInner.innerHTML = `<img src="${url}" style="max-width:85vw;max-height:75vh;border-radius:7px;" />`;
  } else if (url.endsWith('.pdf')) {
    popupInner.innerHTML = `<iframe src="${url}#toolbar=0" style="width:80vw;height:70vh;" allowfullscreen></iframe>`;
  } else {
    popupInner.innerHTML = `<a href="${url}" target="_blank" style="font-size:1.2rem;color:#1976d2;">Download File</a>`;
  }
  popup.style.display = 'flex';
}
function closePreview(ev) {
  document.getElementById('popup-preview').style.display = 'none';
  document.getElementById('popup-inner').innerHTML = '';
}

// Fungsi render OCR (selalu ada tombol expand/minimize walaupun 1 karakter)
function renderOcr(val, expanded) {
  const safeVal = (val || '').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\n/g, '<br>');
  if (!val || val.trim() === '') {
    return `<div class="ocr-block ocr-min" id="ocr-content"><i>(Tidak ada Ringkasan OCR)</i></div>`;
  }
  if (expanded) {
    return `<div class="ocr-block" id="ocr-content">
      <span class="ocr-block-inner">${safeVal}</span>
      <span class="expand-btn" onclick="toggleOcr(false)">[minimize]</span>
    </div>`;
  } else {
    return `<div class="ocr-block ocr-min" id="ocr-content">
      <span class="ocr-block-inner">${safeVal}</span>
      <span class="expand-btn" onclick="toggleOcr(true)">[expand]</span>
    </div>`;
  }
}
function toggleOcr(expanded) {
  const ocrVal = window._ocrValueGlobal || "";
  const ocrDiv = document.getElementById('ocr-content');
  if (!ocrDiv) return;
  ocrDiv.outerHTML = renderOcr(ocrVal, expanded);
}

// Ambil dan render detail sesi
async function loadDetailSesi() {
  if (!matkulId || !sesiId) {
    document.getElementById('detailSesi').innerHTML = '<div style="padding:2rem;text-align:center;">Data tidak ditemukan.</div>';
    return;
  }
  // Info matkul
  const resMatkul = await fetch(`https://ediska-backend.onrender.com/api/matakuliah/${matkulId}`);
  const mk = await resMatkul.json();
  document.getElementById('infoMatkul').innerHTML = `
    <div class="info-box">
      <b>${mk.nama || '-'}</b> | Kode: ${mk.kode || '-'} | SKS: ${mk.sks || '-'}
    </div>
  `;
  // Sesi
  const resSesi = await fetch(`https://ediska-backend.onrender.com/api/matakuliah/sesi/${sesiId}`);
  const sesi = await resSesi.json();
  let docs = Array.isArray(sesi.pdf) ? sesi.pdf : [];
  let judulDocs = Array.isArray(sesi.pdfJudul) ? sesi.pdfJudul : [];
  let noteHtml = '-';
  if (sesi.videoLink && Array.isArray(sesi.videoLink) && sesi.videoLink.length > 0) {
    noteHtml = sesi.videoLink.map((l, i) => {
      let judul = sesi.videoJudul && sesi.videoJudul[i] ? sesi.videoJudul[i] : `Note/Link ${i+1}`;
      return `<div style="white-space:nowrap;"><a href="${l}" target="_blank" class="note-link">${judul}</a></div>`;
    }).join('');
  }
  let dokumenList = docs.length > 0
    ? docs.map((f, i) => {
        let judul = judulDocs[i] || `Dokumen ${i+1}`;
        if (/\.(pdf|jpg|jpeg|png|gif)$/i.test(f))
          return `<button class="doc-link" onclick="popupPreview('${f}')">${judul}</button>`;
        return `<a class="doc-link" href="https://ediska-backend.onrender.com/${f}" download>${judul}</a>`;
      }).join('')
    : '-';

  // Soal dan Jawaban
  let soal = sesi.pelajaran || '-';
  let jawaban = sesi.ringkasan || '-';
  let ocr = sesi.ringkasanOCR ? sesi.ringkasanOCR : '';
  window._ocrValueGlobal = ocr;

  document.getElementById('detailSesi').innerHTML = `
    <div class="sesi-detail-blok">
      <div class="soal-blok"><span class="detail-label">Soal:</span> ${soal}</div>
      <div class="jawaban-blok"><span class="detail-label">Jawaban:</span> ${jawaban}</div>
      <div class="detail-row"><span class="detail-label">Ringkasan OCR:</span> ${renderOcr(ocr, false)}</div>
      <div class="detail-row"><span class="detail-label">Dokumen:</span> ${dokumenList}</div>
      <div class="detail-row"><span class="detail-label">Note/Link:</span> ${noteHtml}</div>
      <div class="detail-row"><span class="detail-label">Nilai:</span> ${sesi.nilai || '-'}</div>
    </div>
  `;
}
document.addEventListener('DOMContentLoaded', loadDetailSesi);
</script>
</body>
</html>
