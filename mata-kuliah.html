<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Input Mata Kuliah - E-DISKA</n  >
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    body { font-family:'Poppins', sans-serif; background:#f3f7fa; margin:0; padding:20px; }
    .container { max-width:800px; margin:0 auto; background:#fff; padding:20px; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.05); }
    h1 { margin-top:0; }
    label { display:block; margin:12px 0 4px; font-weight:500; }
    input, select, textarea { width:100%; padding:8px; border:1px solid #ccc; border-radius:6px; font-family:inherit; }
    .hidden { display:none; }
    button { margin-top:12px; padding:10px 16px; border:none; border-radius:6px; background:#3498db; color:white; cursor:pointer; font-size:16px; }
    button:disabled { opacity:0.6; cursor:not-allowed; }
    #riwayat { margin-top:24px; background:#eef; padding:12px; border-radius:8px; }
    #riwayat h2 { margin-top:0; }
    .session-record { padding:8px; border-bottom:1px solid #ccc; }
    .session-record:last-child { border:none; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Input Mata Kuliah</h1>

    <!-- Form input mata kuliah -->
    <div id="mkForm">
      <label for="namaMatkul">Nama Mata Kuliah</label>
      <input type="text" id="namaMatkul" placeholder="Nama Mata Kuliah" required>
      <label for="kodeMatkul">Kode Mata Kuliah</label>
      <input type="text" id="kodeMatkul" placeholder="Kode Mata Kuliah" required>
      <label for="sksMatkul">Jumlah SKS</label>
      <input type="number" id="sksMatkul" placeholder="Jumlah SKS" required min="0">
      <button id="saveMkBtn">Save Mata Kuliah</button>
    </div>

    <!-- Form sesi, muncul setelah save mata kuliah -->
    <div id="sessionForm" class="hidden">
      <h2>Sesi <span id="sessionNumber">1</span> - Nama Matkulnya apa?</h2>
      <!-- 1. Hal apa dipelajari -->
      <label for="pelajaran">1. Hal apa yang dipelajari?</label>
      <textarea id="pelajaran" rows="3"></textarea>

      <!-- 2. Materi upload -->
      <label>2. Apakah ada materi yang mau diupload?</label>
      <select id="pilihMateri">
        <option value="">--Pilih--</option>
        <option value="ya">Ya</option>
        <option value="tidak">Tidak</option>
      </select>
      <div id="uploadMateri" class="hidden">
        <label for="fileMateri">Upload Materi (PDF/Image)</label>
        <input type="file" id="fileMateri" accept="application/pdf,image/*">
        <label for="judulMateri">Judul Materi</label>
        <input type="text" id="judulMateri" placeholder="Judul Materi">
      </div>

      <!-- 3. File lain -->
      <label>3. Apakah ada file lain yang mau diupload?</label>
      <select id="pilihFileLain">
        <option value="">--Pilih--</option>
        <option value="ya">Ya</option>
        <option value="tidak">Tidak</option>
      </select>
      <div id="uploadLain" class="hidden">
        <label for="fileLain">Upload File Lain</label>
        <input type="file" id="fileLain" accept="application/pdf,image/*">
        <label for="judulLain">Judul File</label>
        <input type="text" id="judulLain" placeholder="Judul File">
      </div>

      <!-- 4. Ringkasan diskusi -->
      <label>4. Apakah ada ringkasan diskusi atau catatan?</label>
      <select id="pilihRingkasan">
        <option value="">--Pilih--</option>
        <option value="ya">Ya</option>
        <option value="tidak">Tidak</option>
      </select>
      <div id="ringkasanDiv" class="hidden">
        <label for="ringkasan">Ringkasan</label>
        <textarea id="ringkasan" rows="3"></textarea>
      </div>

      <!-- 5. Tugas -->
      <label>5. Apakah ada tugas?</label>
      <select id="pilihTugas">
        <option value="">--Pilih--</option>
        <option value="ya">Ya</option>
        <option value="tidak">Tidak</option>
      </select>
      <div id="tugasDiv" class="hidden">
        <label for="fileTugas">Upload Tugas (PDF/Image/Link)</label>
        <input type="file" id="fileTugas" accept="application/pdf,image/*">
        <label for="linkTugas">Link Video (Opsional)</label>
        <input type="url" id="linkTugas" placeholder="https://...">
      </div>

      <!-- 6. Nilai -->
      <label>6. Apakah sudah ada nilai?</label>
      <select id="pilihNilai">
        <option value="">--Pilih--</option>
        <option value="ya">Ya</option>
        <option value="tidak">Tidak</option>
      </select>
      <div id="nilaiDiv" class="hidden">
        <label for="nilai">Nilai</label>
        <input type="text" id="nilai" placeholder="Nilai">
      </div>

      <button id="saveSessionBtn">Simpan Sesi <span id="sessionNumLabel">1</span></button>
    </div>

    <!-- Riwayat sesi -->
    <div id="riwayat" class="hidden">
      <h2>Riwayat Sesi</h2>
      <div id="riwayatList"></div>
    </div>
  </div>

<script>
  // Ambil query semester
  const params = new URLSearchParams(location.search);
  const semester = params.get('semester');
  const user = JSON.parse(localStorage.getItem('user'));
  if (!user) location.href='login.html';

  let mataKuliahId = null;
  let sessionCount = 0;
  let riwayat = [];

  // Elemen
  const mkForm = document.getElementById('mkForm');
  const sessionForm = document.getElementById('sessionForm');
  const riwayatDiv = document.getElementById('riwayat');
  const riwayatList = document.getElementById('riwayatList');

  // Handlers show/hide detail
  function toggleDetail(selId, divId) {
    document.getElementById(selId).addEventListener('change', e => {
      document.getElementById(divId).classList.toggle('hidden', e.target.value !== 'ya');
    });
  }
  ['pilihMateri','pilihFileLain','pilihRingkasan','pilihTugas','pilihNilai']
    .forEach(id => toggleDetail(id, { 'pilihMateri':'uploadMateri', 'pilihFileLain':'uploadLain', 'pilihRingkasan':'ringkasanDiv', 'pilihTugas':'tugasDiv', 'pilihNilai':'nilaiDiv' }[id]));

  // Save mata kuliah
  document.getElementById('saveMkBtn').onclick = async () => {
    const nama = document.getElementById('namaMatkul').value;
    const kode = document.getElementById('kodeMatkul').value;
    const sks  = parseInt(document.getElementById('sksMatkul').value) || 0;
    const body = { userId:user._id, semester, nama, kode, sks };
    const res = await fetch('https://ediska-backend.onrender.com/api/matakuliah', {
      method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body)
    });
    const data = await res.json();
    mataKuliahId = data._id;
    mkForm.classList.add('hidden');
    sessionForm.classList.remove('hidden');
    riwayatDiv.classList.remove('hidden');
    loadRiwayat();
  };

  // Save sesi
  document.getElementById('saveSessionBtn').onclick = async () => {
    const sesi = sessionCount + 1;
    const payload = { session:sesi, pelajaran:document.getElementById('pelajaran').value };
    if (document.getElementById('pilihMateri').value==='ya') {
      payload.materi = {
        file: document.getElementById('fileMateri').files[0],
        judul: document.getElementById('judulMateri').value
      };
    }
    if (document.getElementById('pilihFileLain').value==='ya') {
      payload.fileLain = {
        file: document.getElementById('fileLain').files[0],
        judul: document.getElementById('judulLain').value
      };
    }
    if (document.getElementById('pilihRingkasan').value==='ya') {
      payload.ringkasan = document.getElementById('ringkasan').value;
    }
    if (document.getElementById('pilihTugas').value==='ya') {
      payload.tugas = {
        file: document.getElementById('fileTugas').files[0],
        link: document.getElementById('linkTugas').value
      };
    }
    if (document.getElementById('pilihNilai').value==='ya') {
      payload.nilai = document.getElementById('nilai').value;
    }
    // Kirim form-data jika ada file
    const form = new FormData();
    form.append('userId', user._id);
    form.append('matakuliahId', mataKuliahId);
    form.append('session', sesi);
    form.append('pelajaran', payload.pelajaran);
    if (payload.materi) { form.append('materiFile', payload.materi.file); form.append('materiJudul', payload.materi.judul); }
    if (payload.fileLain) { form.append('fileLain', payload.fileLain.file); form.append('fileLainJudul', payload.fileLain.judul); }
    if (payload.ringkasan) form.append('ringkasan', payload.ringkasan);
    if (payload.tugas) { form.append('tugasFile', payload.tugas.file); form.append('tugasLink', payload.tugas.link); }
    if (payload.nilai) form.append('nilai', payload.nilai);

    await fetch('https://ediska-backend.onrender.com/api/matakuliah/sessions', {
      method:'POST', body: form
    });
    loadRiwayat();
    sessionCount++;
    document.getElementById('sessionNumber').innerText = sessionCount+1;
    document.getElementById('sessionNumLabel').innerText = sessionCount+1;
  };

  // Load riwayat sesi
  async function loadRiwayat() {
    const res = await fetch(`https://ediska-backend.onrender.com/api/matakuliah/${mataKuliahId}/sessions`);
    riwayat = await res.json();
    riwayatList.innerHTML = riwayat.map(r=>
      `<div class="session-record">
        <strong>Sesi ${r.session}</strong>: ${r.pelajaran}
      </div>`
    ).join('');
  }
</script>
</body>
</html>
