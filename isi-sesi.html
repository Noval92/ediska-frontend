<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ISI SESI MATA KULIAH</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body { background: #f5f8fa; font-family: 'Poppins', sans-serif; }
    .container { max-width: 600px; margin: 30px auto 80px; background: #fff; border-radius: 18px; box-shadow: 0 6px 28px #0001; padding: 2rem; }
    .header { background: #2596e5; color: #fff; padding: 1.2rem; border-radius: 12px 12px 0 0; font-size: 1.6rem; text-align: center; font-weight: 600; margin-bottom: 18px;}
    .sesi-blok { border: 2px solid #2596e5; border-radius: 10px; margin-bottom: 18px; padding: 12px 18px; background: #f8fafc;}
    .sesi-header { font-weight: bold; font-size: 1.1em; color: #1976d2; margin-bottom: 8px; }
    label { margin-top: 8px; display: block; font-weight: 600;}
    input[type="text"], input[type="number"], textarea { width: 100%; padding: 8px; margin: 4px 0 12px 0; border-radius: 7px; border: 1px solid #d4dbe5;}
    textarea { min-height: 60px;}
    .pdf-list, .note-list { margin: 8px 0 0 0; }
    .note-item, .pdf-item { margin-bottom: 9px; display: flex; gap: 6px; align-items: center;}
    .btn-hapus-note, .btn-hapus-pdf { background: #ff4d4d; color: #fff; border: none; border-radius: 6px; padding: 2px 10px; font-size: .93em; cursor: pointer;}
    .btn-tambah-note, .btn-tambah-pdf { background: #2596e5; color: #fff; border: none; border-radius: 6px; padding: 6px 12px; font-size: .98em; margin-bottom: 8px; cursor: pointer;}
    .btn-submit { background: #2596e5; color: #fff; border: none; border-radius: 7px; padding: 10px 24px; font-size: 1.13em; margin-top: 18px; width: 100%;}
    .btn-kembali { background: #8fa7b9; color: #fff; border: none; border-radius: 8px; padding: 7px 18px; font-size: 1.01em; margin-bottom: 18px; }
    footer {
      position: fixed; left: 0; right: 0; bottom: 0; z-index: 99;
      background: #fff; box-shadow: 0 -1px 6px rgba(0,0,0,0.07);
      display: flex; justify-content: space-around; padding: 10px 0;
    }
    footer a { text-decoration: none; color: #2596e5; font-size: 16px; text-align: center;}
    @media (max-width: 700px) {
      .container { max-width: 98vw; padding: 0.5rem;}
      .btn-submit { padding: 10px 8px;}
    }
  </style>
</head>
<body>
  <div class="container">
    <button onclick="window.history.back()" class="btn-kembali">&larr; Kembali</button>
    <div class="header">ISI SESI MATA KULIAH</div>
    <div id="sesiList"></div>
    <form id="formSesi">
      <div class="sesi-header" id="judulSesi"></div>
      <label>Hal apa yang dipelajari?</label>
      <input type="text" id="pelajaran" placeholder="Contoh: Sesi 1 - Instalasi ..." required>
      <label>Ringkasan belajar sesi ini</label>
      <textarea id="ringkasan"></textarea>
      <label>Upload Dokumen (max 10)</label>
      <div id="pdfList"></div>
      <button type="button" class="btn-tambah-pdf" onclick="tambahPdf()">+ Tambah Dokumen</button>
      <label>Link / Note (max 10)</label>
      <div id="noteList"></div>
      <button type="button" class="btn-tambah-note" onclick="tambahNote()">+ Tambah Note</button>
      <label>Nilai (opsional)</label>
      <input type="number" id="nilai" min="0" max="100">
      <button type="submit" class="btn-submit">Simpan Sesi</button>
    </form>
  </div>
  <footer>
    <a href="dashboard.html">üè†<br>Dashboard</a>
    <a href="arsip.html">üìö<br>Arsip</a>
    <a href="logout.html" onclick="localStorage.clear()">üö™<br>Logout</a>
  </footer>

<script>
let sesiUrutan = 1;
let pdfIdx = 0, noteIdx = 0;

// Tampilkan list sesi yang sudah ada
async function loadSesiList() {
  const params = new URLSearchParams(window.location.search);
  const matkulId = params.get('matkul_id');
  if (!matkulId) return;
  const res = await fetch(`https://ediska-backend.onrender.com/api/matakuliah/${matkulId}/sesi`);
  const sesiList = await res.json();
  const div = document.getElementById('sesiList');
  div.innerHTML = '';
  sesiUrutan = (sesiList.length || 0) + 1;
  sesiList.forEach((s, i) => {
    div.innerHTML += `
      <div class="sesi-blok">
        <div class="sesi-header">Sesi ${i+1}</div>
        <div><b>Hal yang dipelajari:</b> ${s.pelajaran || '-'}</div>
        <div><b>Ringkasan:</b> ${s.ringkasan || '-'}</div>
        <div><b>Dokumen:</b> ${(s.pdfJudul||[]).map((j,idx)=>j?`<a href="https://ediska-backend.onrender.com/${s.pdf[idx]}" target="_blank">${j}</a>`:'').join(', ')||'-'}</div>
        <div><b>Note/Link:</b> ${(s.videoJudul||[]).map((n,idx)=>s.videoLink&&s.videoLink[idx]?`<a href="${s.videoLink[idx]}" target="_blank">${n}</a>`:n).join(', ')||'-'}</div>
        <div><b>Nilai:</b> ${s.nilai||'-'}</div>
      </div>
    `;
  });
  document.getElementById('judulSesi').innerHTML = `Sesi ${sesiUrutan}`;
}

// Tambah PDF row dinamis
function tambahPdf() {
  if (pdfIdx >= 9) return alert('Maksimal 10 dokumen!');
  pdfIdx++;
  const list = document.getElementById('pdfList');
  const idx = pdfIdx;
  list.insertAdjacentHTML('beforeend', `
    <div class="pdf-item" id="pdfItem${idx}">
      <input type="text" name="pdfJudul[]" placeholder="Judul dokumen">
      <input type="file" name="pdfFile[]" accept=".pdf,.jpg,.png,.jpeg">
      <button type="button" class="btn-hapus-pdf" onclick="hapusPdf(${idx})">Hapus</button>
    </div>
  `);
}
function hapusPdf(idx) {
  document.getElementById('pdfItem'+idx)?.remove();
  pdfIdx--;
}

// Tambah Note row dinamis
function tambahNote() {
  if (noteIdx >= 9) return alert('Maksimal 10 note!');
  noteIdx++;
  const list = document.getElementById('noteList');
  const idx = noteIdx;
  list.insertAdjacentHTML('beforeend', `
    <div class="note-item" id="noteItem${idx}">
      <input type="text" name="videoJudul[]" placeholder="Judul Note/Video">
      <input type="text" name="videoLink[]" placeholder="Isi Note atau link (boleh teks)">
      <button type="button" class="btn-hapus-note" onclick="hapusNote(${idx})">Hapus</button>
    </div>
  `);
}
function hapusNote(idx) {
  document.getElementById('noteItem'+idx)?.remove();
  noteIdx--;
}

// Handle submit sesi
document.getElementById('formSesi').onsubmit = async function(e) {
  e.preventDefault();
  const params = new URLSearchParams(window.location.search);
  const matkulId = params.get('matkul_id');
  const formData = new FormData();
  formData.append('matkulId', matkulId);
  formData.append('pelajaran', document.getElementById('pelajaran').value);
  formData.append('ringkasan', document.getElementById('ringkasan').value);
  formData.append('nilai', document.getElementById('nilai').value);

  // PDF (multi file)
  const pdfJuduls = document.getElementsByName('pdfJudul[]');
  const pdfFiles = document.getElementsByName('pdfFile[]');
  for (let i = 0; i < pdfJuduls.length; i++) {
    formData.append('pdfJudul[]', pdfJuduls[i].value);
    if (pdfFiles[i]?.files[0]) formData.append('pdfFile[]', pdfFiles[i].files[0]);
  }
  // Note/Link (boleh hanya teks)
  const videoJuduls = document.getElementsByName('videoJudul[]');
  const videoLinks = document.getElementsByName('videoLink[]');
  for (let i = 0; i < videoJuduls.length; i++) {
    formData.append('videoJudul[]', videoJuduls[i].value);
    formData.append('videoLink[]', videoLinks[i].value);
  }

  await fetch('https://ediska-backend.onrender.com/api/matakuliah/sesi', {
    method: 'POST', body: formData
  });
  this.reset();
  document.getElementById('pdfList').innerHTML = '';
  document.getElementById('noteList').innerHTML = '';
  pdfIdx = 0; noteIdx = 0;
  loadSesiList();
};

window.onload = loadSesiList;
</script>
</body>
</html>
