<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ISI SESI MATA KULIAH</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Poppins', sans-serif; background: #f1f5f9; margin: 0; padding: 0 0 80px 0;}
    .container { max-width: 650px; margin: 32px auto 0 auto; background: white; padding: 1.5rem 1rem; border-radius: 18px; box-shadow: 0 4px 16px rgba(0,0,0,0.06);}
    h2 { text-align: center; background: #3498db; color: #fff; margin: 0 0 1.2rem 0; padding: 1.2rem 0; border-radius: 12px 12px 0 0; font-size: 1.4rem;}
    .sesi-blok {border:2px solid #3498db;border-radius:10px;margin:15px 0 22px 0;padding:12px 14px;background: #f8fbfd;}
    .sesi-header { font-weight:bold;font-size:1.12em;margin-bottom:8px;color:#1976d2; }
    .form-label {font-weight:600;margin-top:14px;display:block;}
    .doc-link { color: #1976d2; text-decoration: underline; margin-right: 9px; font-size: 1em; cursor:pointer; background: none; border: none;}
    .note-row {margin-bottom:7px;}
    .note-input, .note-title {margin-right:7px;padding:3px 7px;font-size:1em;}
    .hapus-btn { background:#e74c3c; color:#fff; border:none; border-radius:3px; padding:2px 9px; margin-left:5px; cursor:pointer;}
    .hapus-btn:hover { background:#c0392b;}
    .file-preview {margin-top:5px;}
    .urutan-sesi-blok {font-weight:bold;font-size:1.1em; background:#e3f2fd; padding:7px 0 7px 12px; border-radius:8px; margin:12px 0;}
    .form-btn { background: #3498db; color: #fff; border: none; border-radius: 7px; padding: 9px 25px; font-size: 1.15em; font-weight:600; cursor: pointer; transition: background 0.18s; margin-top:15px;}
    .form-btn:hover { background: #1976d2; }
    @media (max-width: 700px) {.container { max-width: 98vw; padding: 0.6rem; } h2{font-size:1.1rem;} }
    .back-btn { display:inline-block; background:#95a5a6; color:#fff; border:none; border-radius:6px; padding:5px 17px; margin-bottom:0.8rem; font-size:1rem; cursor:pointer;transition:background 0.2s;}
    .back-btn:hover { background: #636e72; }
  </style>
</head>
<body>
  <div class="container">
    <button class="back-btn" onclick="window.history.back()">‚Üê Kembali</button>
    <h2>ISI SESI MATA KULIAH</h2>
    <div id="list-sesi"></div>
    <form id="formSesi" autocomplete="off" enctype="multipart/form-data">
      <div id="urutan-sesi"></div>
      <label class="form-label">Hal apa yang dipelajari?</label>
      <input type="text" id="pelajaran" placeholder="Contoh: Sesi 1 - Instalasi ..." required style="width:98%;padding:7px;margin-bottom:6px;" />
      
      <label class="form-label">Ringkasan belajar sesi ini</label>
      <textarea id="ringkasan" rows="3" style="width:98%;padding:7px;margin-bottom:6px;"></textarea>
      
      <label class="form-label">Upload Dokumen (max 10)</label>
      <input type="file" id="pdfFile" multiple accept=".pdf,.jpg,.png,.jpeg"/>
      <div id="pdfPreviewList" class="file-preview"></div>
      
      <label class="form-label">Link / Note (max 10)</label>
      <div id="note-list"></div>
      <button type="button" onclick="tambahNote()" class="form-btn" style="background:#55c77b;margin-bottom:10px;">+ Tambah Note</button>
      
      <label class="form-label">Nilai (opsional)</label>
      <input type="number" id="nilai" min="0" max="100" style="width:90px;"/>
      <br>
      <button type="submit" class="form-btn">Simpan Sesi</button>
    </form>
  </div>
  <script>
    // Utility untuk ambil matkul_id dari URL
    function getMatkulIdDariURL() {
      const params = new URLSearchParams(window.location.search);
      return params.get('matkul_id');
    }

    let sesiData = [];
    let sesiUrutan = 1;
    let noteIdx = 0;

    async function loadSesiList() {
      const matkulId = getMatkulIdDariURL();
      if (!matkulId) return;
      // Get all sesi
      const res = await fetch(`/api/matakuliah/${matkulId}/sesi`);
      sesiData = await res.json();
      sesiUrutan = (sesiData.length || 0) + 1;

      // Tampilkan blok sesi yang sudah diisi
      let html = '';
      sesiData.forEach((s, i) => {
        html += `
          <div class="sesi-blok">
            <div class="sesi-header">Sesi ${i + 1}</div>
            <div><b>Hal yang dipelajari:</b> ${s.pelajaran || '-'}</div>
            <div><b>Ringkasan:</b> ${s.ringkasan || '-'}</div>
            <div><b>Dokumen:</b> ${
              s.pdfJudul?.map((j, idx) => {
                if (!s.pdf || !s.pdf[idx]) return '';
                let url = s.pdf[idx].startsWith('http') ? s.pdf[idx] : `/` + s.pdf[idx];
                return `<a class="doc-link" href="${url}" target="_blank">${j || 'Dokumen'}</a>`;
              }).join('') || '-'
            }</div>
            <div><b>Note/Link:</b> ${
              s.videoJudul?.map((n, idx) => {
                let val = s.videoLink && s.videoLink[idx] ? s.videoLink[idx] : '';
                // Kalau ada link, dijadikan link, kalau tidak, tampil teks saja
                return val 
                  ? `<a class="doc-link" href="${val}" target="_blank">${n || val}</a>` 
                  : `<span style="margin-right:7px">${n || '-'}</span>`;
              }).join('') || '-'
            }</div>
            <div><b>Nilai:</b> ${s.nilai || '-'}</div>
          </div>
        `;
      });
      document.getElementById('list-sesi').innerHTML = html;

      // Urutan sesi otomatis
      document.getElementById('urutan-sesi').innerHTML = 
        `<div class="urutan-sesi-blok">Sesi ${sesiUrutan}</div>`;
    }

    // Handle file preview
    document.getElementById('pdfFile').addEventListener('change', function() {
      const files = this.files;
      const list = document.getElementById('pdfPreviewList');
      let html = '';
      for(let i=0; i<files.length; i++) {
        html += `<div>File: ${files[i].name}</div>`;
      }
      list.innerHTML = html;
    });

    // Untuk tambah note/link tanpa validasi wajib url
    function tambahNote() {
      const list = document.getElementById('note-list');
      noteIdx++;
      list.insertAdjacentHTML('beforeend', `
        <div class="note-row" id="note${noteIdx}">
          <input type="text" class="note-title" name="videoJudul[]" placeholder="Judul Note/Video" />
          <input type="text" class="note-input" name="videoLink[]" placeholder="Isi Note atau link (boleh teks saja)" />
          <button type="button" class="hapus-btn" onclick="this.parentNode.remove()">Hapus</button>
        </div>
      `);
    }

    // Handle submit form sesi
    document.getElementById('formSesi').onsubmit = async function(e) {
      e.preventDefault();
      const matkulId = getMatkulIdDariURL();
      if (!matkulId) { alert('ID matkul tidak ditemukan di URL.'); return; }

      const formData = new FormData();
      formData.append('matkulId', matkulId);
      formData.append('pelajaran', document.getElementById('pelajaran').value);
      formData.append('ringkasan', document.getElementById('ringkasan').value);
      formData.append('nilai', document.getElementById('nilai').value);

      // PDF upload
      const pdfFiles = document.getElementById('pdfFile').files;
      for (let i=0; i < pdfFiles.length; i++) {
        formData.append('pdfFile[]', pdfFiles[i]);
      }

      // Note & Link (boleh teks biasa)
      const notes = document.querySelectorAll('[name="videoJudul[]"]');
      const links = document.querySelectorAll('[name="videoLink[]"]');
      notes.forEach((n, idx) => {
        formData.append('videoJudul[]', n.value);
        formData.append('videoLink[]', links[idx].value);
      });

      await fetch(`/api/matakuliah/sesi`, { method: 'POST', body: formData });
      // Refresh list sesi setelah submit
      await loadSesiList();
      this.reset();
      noteIdx = 0;
      document.getElementById('note-list').innerHTML = '';
      document.getElementById('pdfPreviewList').innerHTML = '';
    };

    window.onload = loadSesiList;
  </script>
</body>
</html>
