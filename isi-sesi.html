<!-- isi-sesi.html -->
<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ISI SESI MATA KULIAH</title>
  <style>
    :root { --primary: #3498db; --bg: #f1f5f9; }

    body {
      font-family: 'Segoe UI', sans-serif;
      background: var(--bg);
      margin: 0;
      padding: 0 0 80px 0;
    }
    .container { max-width: 95%; margin: 2rem auto 1rem auto; background: #fff; padding: 1.5rem; border-radius: 12px; box-shadow: 0 4px 16px rgba(0,0,0,0.06); }
    h2 { background: var(--primary); color: white; padding: 1rem; border-radius: 8px 8px 0 0; text-align: center; font-size: 1.3rem; }
    .matkul-info { background: #e3f2fd; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem; font-size: 1.1rem; }
    .sesi-list { margin-bottom: 2rem; }
    .sesi-box {
      background: #f9f9f9;
      padding: 1rem 1.2rem;
      border-left: 5px solid var(--primary);
      margin-bottom: 1rem;
      border-radius: 8px;
    }
    .sesi-title { font-weight: bold; margin-bottom: 4px; }
    .sesi-detail { font-size: 0.98rem; color: #34495e; }
    .actions { margin-top: 10px; }
    .actions button {
      margin-right: 8px;
      background: #e74c3c;
      color: white;
      border: none;
      padding: 5px 12px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 0.93rem;
    }
    .actions .btn-edit {
      background: #f39c12;
    }
    .actions .btn-add {
      background: #2ecc71;
    }
    .add-sesi-form {
      background: #e3f2fd;
      padding: 14px;
      border-radius: 8px;
      margin-bottom: 1.5rem;
      margin-top: 0.5rem;
    }
    input, textarea { width: 100%; padding: 0.6rem; margin-top: 0.3rem; border: 1px solid #ccc; border-radius: 6px; font-size: 0.95rem; margin-bottom: 0.6rem;}
    label { font-weight: 600; margin-top: 0.7rem; display: block; }
    .btn-kembali {
      background: #95a5a6; color: white; border: none; padding: 5px 20px; border-radius: 5px; margin-bottom: 1.5rem; cursor: pointer;
    }
    @media (max-width:600px) {
      .container { padding: 1rem;}
      .sesi-box { padding: 1rem 0.5rem; }
    }
  </style>
</head>
<body>
  <div class="container">
    <button class="btn-kembali" onclick="window.history.back()">‚Üê Kembali</button>
    <h2>ISI SESI MATA KULIAH</h2>
    <div id="matkulInfo" class="matkul-info"></div>
    <div class="sesi-list" id="sesiList"></div>

    <h3 style="color:#3498db;margin-top:30px;">Tambah Sesi Baru</h3>
    <form id="addSesiForm" class="add-sesi-form">
      <label>Hal apa yang dipelajari?</label>
      <textarea name="pelajaran" required placeholder="Contoh: Sesi 1 - Instalasi dan konfigurasi ..."></textarea>

      <label>Ringkasan belajar sesi ini</label>
      <textarea name="ringkasan" rows="3" placeholder="Tuliskan ringkasan belajar sesi ini..."></textarea>

      <label>Upload Dokumen (max 10)</label>
      <div id="pdfContainer"></div>
      <button type="button" onclick="addPdf()" style="background:#3498db;color:white;border:none;padding:4px 10px;border-radius:4px;cursor:pointer;margin-bottom:12px;">+ Tambah Dokumen</button>

      <label>Link / Note (max 10)</label>
      <div id="videoContainer"></div>
      <button type="button" onclick="addVideo()" style="background:#3498db;color:white;border:none;padding:4px 10px;border-radius:4px;cursor:pointer;">+ Tambah Note</button>

      <label>Nilai (opsional)</label>
      <input type="number" name="nilai" min="0" max="100" placeholder="0‚Äì100" />

      <button type="submit" class="btn-add" style="margin-top:1rem;">Simpan Sesi</button>
    </form>
  </div>
  <footer style="position:fixed;bottom:0;width:100%;background:#fff;box-shadow:0 -1px 6px rgba(0,0,0,0.05);display:flex;justify-content:space-around;padding:10px 0;z-index:1000;">
    <a href="dashboard.html" style="text-decoration:none;color:#3498db;text-align:center;">üè†<br>Dashboard</a>
    <a href="arsip.html" style="text-decoration:none;color:#3498db;text-align:center;">üìö<br>Arsip</a>
    <a href="login.html" onclick="localStorage.clear()" style="text-decoration:none;color:#e74c3c;text-align:center;">üö™<br>Logout</a>
  </footer>
  <script>
    const user = JSON.parse(localStorage.getItem('user'));
    if (!user || !user._id) window.location = 'login.html';
    const matkulId = new URLSearchParams(location.search).get('matkul_id');
    let matkulData = {};

    // Tampilkan info matkul
    async function loadMatkulInfo() {
      const res = await fetch(`https://ediska-backend.onrender.com/api/matakuliah/${matkulId}`);
      const matkul = await res.json();
      matkulData = matkul;
      document.getElementById('matkulInfo').innerHTML = `
        <div><b>${matkul.nama}</b> (${matkul.kode}) - ${matkul.sks} SKS</div>
      `;
    }

    // Tampilkan list sesi
    async function loadSesiList() {
      const res = await fetch(`https://ediska-backend.onrender.com/api/matakuliah/${matkulId}/sesi`);
      const sesiList = await res.json();
      document.getElementById('sesiList').innerHTML = sesiList.length === 0 ? "<i>Belum ada sesi.</i>" : 
        sesiList.map((s, i) => `
          <div class="sesi-box">
            <div class="sesi-title">Sesi ${i + 1} - ${s.pelajaran || ''}</div>
            <div class="sesi-detail">${s.ringkasan ? s.ringkasan : ""}</div>
            ${Array.isArray(s.pdf) && s.pdf.length > 0 ? `
              <div style="margin:8px 0;"><b>Dokumen:</b>
                <ul>
                  ${s.pdf.map((p, idx) => `<li>${s.pdfJudul?.[idx] || 'Tanpa Judul'} - <a href="https://ediska-backend.onrender.com/${p}" target="_blank">Lihat/Download</a></li>`).join('')}
                </ul>
              </div>
            ` : ''}
            ${Array.isArray(s.videoLink) && s.videoLink.length > 0 ? `
              <div style="margin:8px 0;"><b>Note:</b>
                <ul>
                  ${s.videoLink.map((v, idx) => `<li>${s.videoJudul?.[idx] || 'Video'}: <a href="${v}" target="_blank">${v}</a></li>`).join('')}
                </ul>
              </div>
            ` : ''}
            ${s.nilai ? `<div style="margin:6px 0;">Nilai: <b>${s.nilai}</b></div>` : ""}
            <div class="actions">
              <button class="btn-edit" onclick="editSesi('${s._id}')">Edit</button>
              <button onclick="hapusSesi('${s._id}')">Hapus</button>
            </div>
          </div>
        `).join('');
    }

    // Tambah sesi
    document.getElementById('addSesiForm').onsubmit = async function(e) {
      e.preventDefault();
      const fd = new FormData();
      fd.append('matkulId', matkulId);
      fd.append('pelajaran', this.pelajaran.value);
      fd.append('ringkasan', this.ringkasan.value);
      fd.append('nilai', this.nilai.value);

      // PDF
      const pdfJudul = this.querySelectorAll('input[name="pdfJudul[]"]');
      const pdfFile = this.querySelectorAll('input[name="pdfFile[]"]');
      pdfJudul.forEach((el, i) => {
        fd.append('pdfJudul[]', el.value);
        if (pdfFile[i]?.files[0]) {
          fd.append('pdfFile[]', pdfFile[i].files[0]);
        }
      });
      // Video/Note
      const videoJudul = this.querySelectorAll('input[name="videoJudul[]"]');
      const videoLink = this.querySelectorAll('input[name="videoLink[]"]');
      videoJudul.forEach((el, i) => {
        fd.append('videoJudul[]', el.value);
        fd.append('videoLink[]', videoLink[i].value);
      });

      await fetch(`https://ediska-backend.onrender.com/api/matakuliah/sesi`, {
        method: 'POST',
        body: fd,
      });
      this.reset();
      document.getElementById('pdfContainer').innerHTML = '';
      document.getElementById('videoContainer').innerHTML = '';
      await loadSesiList();
    };

    // Edit sesi (popup form sederhana, bisa dikembangkan lebih lanjut)
    window.editSesi = async (sesiId) => {
      alert('Fitur edit sesi bisa dikembangkan lanjut. (Bisa re-use form tambah, lalu update data via API /matakuliah/sesi/:id dengan method PUT)');
    };

    // Hapus sesi
    window.hapusSesi = async (sesiId) => {
      if (!confirm('Yakin hapus sesi ini?')) return;
      await fetch(`https://ediska-backend.onrender.com/api/matakuliah/sesi/${sesiId}`, { method: 'DELETE' });
      await loadSesiList();
    };

    // Tambah input PDF
    function addPdf() {
      const container = document.getElementById('pdfContainer');
      if (container.children.length >= 10) return alert('Maksimal 10 file PDF');
      const div = document.createElement('div');
      div.innerHTML = `
        <input type="text" name="pdfJudul[]" placeholder="Judul PDF" />
        <input type="file" name="pdfFile[]" accept=".pdf" />
        <button type="button" onclick="this.parentNode.remove()">‚ùå</button>
      `;
      container.appendChild(div);
    }
    // Tambah input video/note
    function addVideo() {
      const container = document.getElementById('videoContainer');
      if (container.children.length >= 10) return alert('Maksimal 10 link/video');
      const div = document.createElement('div');
      div.innerHTML = `
        <input type="text" name="videoJudul[]" placeholder="Judul Note/Video" />
        <input type="url" name="videoLink[]" placeholder="https://..." />
        <button type="button" onclick="this.parentNode.remove()">‚ùå</button>
      `;
      container.appendChild(div);
    }

    // INIT
    document.addEventListener('DOMContentLoaded', async () => {
      await loadMatkulInfo();
      await loadSesiList();
    });
  </script>
</body>
</html>
