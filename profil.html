<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Profil Mahasiswa</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Poppins', sans-serif; background: #f5f7fa; margin: 0; }
    .container { max-width: 480px; margin: 30px auto; background: #fff; padding: 2rem 1.5rem; border-radius: 12px; box-shadow: 0 6px 20px #0001;}
    h2 { text-align: center; color: #3498db; margin-bottom: 24px;}
    .form-group { margin-bottom: 18px; }
    label { font-weight: 600; }
    input, select { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #ccc; font-size: 15px; margin-top: 6px;}
    button { width: 100%; background: #3498db; color: #fff; padding: 12px; border: none; border-radius: 8px; font-weight: 600; margin-top: 16px; cursor: pointer;}
    .photo-preview { text-align: center; margin-bottom: 18px;}
    .photo-preview img { width: 90px; height: 90px; border-radius: 50%; object-fit: cover; border: 2px solid #3498db; }
    .footer { position: fixed; bottom: 0; left: 0; width: 100%; background: #fff; border-top: 1px solid #eee; display: flex; justify-content: space-around; padding: 8px 0;}
    .footer a { color: #3498db; text-decoration: none; font-size: 15px; text-align: center;}
  </style>
</head>
<body>
  <div class="container">
    <h2>Profil Mahasiswa</h2>
    <form id="profilForm" enctype="multipart/form-data">
      <div class="photo-preview">
        <img id="previewFoto" src="https://cdn-icons-png.flaticon.com/512/149/149071.png" alt="Foto Profil">
      </div>
      <div class="form-group">
        <label>Nama Lengkap</label>
        <input type="text" name="nama" id="nama" required>
      </div>
      <div class="form-group">
        <label>NIM</label>
        <input type="text" name="nim" id="nim" required>
      </div>
      <div class="form-group">
        <label>Email</label>
        <input type="email" name="email" id="email" required disabled>
      </div>
      <div class="form-group">
        <label>No HP</label>
        <input type="text" name="nohp" id="nohp">
      </div>
      <div class="form-group">
        <label>Domisili</label>
        <input type="text" name="domisili" id="domisili">
      </div>
      <div class="form-group">
        <label>Semester</label>
        <select name="semester" id="semester" required>
          <option value="">-- Pilih Semester --</option>
          <option>1</option><option>2</option><option>3</option>
          <option>4</option><option>5</option><option>6</option>
          <option>7</option><option>8</option>
        </select>
      </div>
      <div class="form-group">
        <label>Foto Profil</label>
        <input type="file" name="foto" id="foto" accept="image/*">
      </div>
      <button type="submit">Simpan</button>
    </form>
  </div>
  <div class="footer">
    <a href="dashboard.html">üè†<br>Beranda</a>
    <a href="semester.html">üéì<br>Semester</a>
    <a href="arsip.html">üìö<br>Arsip</a>
    <a href="profil.html">üë§<br>Profil</a>
    <a href="login.html" onclick="localStorage.clear()">üö™<br>Logout</a>
  </div>
  <script>
    // Fetch user data dari localStorage
    const user = JSON.parse(localStorage.getItem('user'));
    if (!user || !user._id) window.location = 'login.html';

    // Tampilkan data ke form
    async function loadProfile() {
      // Ambil data terbaru dari server
      const res = await fetch(`https://ediska-backend.onrender.com/api/students/${user._id}`);
      const data = await res.json();

      document.getElementById('nama').value = data.nama || '';
      document.getElementById('nim').value = data.nim || '';
      document.getElementById('email').value = data.email || '';
      document.getElementById('nohp').value = data.nohp || '';
      document.getElementById('domisili').value = data.domisili || '';
      document.getElementById('semester').value = data.semester || '';

      if (data.foto) {
        document.getElementById('previewFoto').src = data.foto.startsWith('http') ? data.foto : `https://ediska-backend.onrender.com/${data.foto}`;
      }
    }

    // Preview Foto
    document.getElementById('foto').addEventListener('change', function (e) {
      const reader = new FileReader();
      reader.onload = function () {
        document.getElementById("previewFoto").src = reader.result;
      };
      if (e.target.files[0]) reader.readAsDataURL(e.target.files[0]);
    });

    // Submit Edit Profil
    document.getElementById('profilForm').onsubmit = async function (e) {
      e.preventDefault();
      const fd = new FormData(this);

      const res = await fetch(`https://ediska-backend.onrender.com/api/students/${user._id}`, {
        method: 'PUT',
        body: fd
      });
      const result = await res.json();

      if (result._id || result.success) {
        alert('Profil berhasil diupdate');
        // Update localStorage
        const getData = await fetch(`https://ediska-backend.onrender.com/api/students/${user._id}`);
        const dataBaru = await getData.json();
        localStorage.setItem('user', JSON.stringify(dataBaru));
        window.location.reload();
      } else {
        alert(result.message || result.error || 'Gagal update profil!');
      }
    }

    loadProfile();
  </script>
</body>
</html>
