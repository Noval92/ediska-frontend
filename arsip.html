<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ARSIP AKADEMIK</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@600&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Poppins', Arial, sans-serif; background: #f6f9fc; margin: 0;}
    h1 { text-align: center; color: #fff; background: #3498db; margin: 0; padding: 30px 0 20px 0; letter-spacing: 2px;}
    .semester-box { margin: 24px auto 0 auto; border-radius: 12px; overflow: hidden; background: #fff; max-width: 96%; box-shadow: 0 3px 12px #0001; }
    .sem-header { background: #2980b9; color: #fff; font-size: 20px; font-weight: 600; padding: 16px 24px; display: flex; align-items: center; justify-content: space-between; cursor: pointer; border-radius: 12px 12px 0 0;}
    .sem-header span {font-weight: 400; font-size: 15px;}
    .table-container { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; margin: 0; }
    th, td { padding: 10px 12px; border-bottom: 1px solid #eee; font-size: 15px; }
    th { background: #f2f6fa; font-weight: 700; }
    td { background: #fff; }
    .popup-bg { display: none; position:fixed; left:0; top:0; width:100vw; height:100vh; background:rgba(40,44,52,0.45); z-index:10000; align-items: center; justify-content: center;}
    .popup-content { background:#fff; border-radius:8px; padding:16px; max-width:95vw; max-height:90vh; box-shadow:0 8px 32px #0006; overflow:auto;}
    .popup-content img, .popup-content iframe {max-width: 100%; max-height: 80vh; display:block; margin: 0 auto;}
    .min-btn {cursor:pointer; border:none; background:#3498db; color:#fff; border-radius:5px; font-size:15px; padding:1px 9px;}
    @media (max-width: 700px) {
      h1 {font-size: 22px;}
      th, td { font-size: 13px; padding: 7px 5px;}
      .sem-header {font-size:15px; padding: 13px 10px;}
      .semester-box {margin: 14px 0;}
    }
    /* NavBar bawah */
    footer { position:fixed; bottom:0; left:0; width:100%; background:#fff; box-shadow:0 -1px 8px #0002; display:flex; justify-content:space-around; z-index:90; }
    footer a { color: #2980b9; text-decoration: none; font-size: 13px; padding: 8px 0; text-align:center;}
    .nav-ico {font-size:24px; display:block; margin-bottom:2px;}
  </style>
</head>
<body>
  <h1>ARSIP AKADEMIK</h1>
  <div id="arsipRoot"></div>

  <!-- PopUp Preview -->
  <div class="popup-bg" id="popupBg" onclick="closePopup()">
    <div class="popup-content" id="popupContent" onclick="event.stopPropagation()"></div>
  </div>

  <footer>
    <a href="dashboard.html"><span class="nav-ico">üè†</span>Beranda</a>
    <a href="semester.html"><span class="nav-ico">üéì</span>Semester</a>
    <a href="arsip.html"><span class="nav-ico">üìö</span>Arsip</a>
    <a href="profil.html"><span class="nav-ico">üë§</span>Profil</a>
    <a href="login.html" onclick="localStorage.clear()"><span class="nav-ico">üö™</span>Log Out</a>
  </footer>

  <script>
    // --- POPUP
    function showPopup(content) {
      document.getElementById("popupContent").innerHTML = content;
      document.getElementById("popupBg").style.display = "flex";
    }
    function closePopup() {
      document.getElementById("popupBg").style.display = "none";
      document.getElementById("popupContent").innerHTML = "";
    }

    // --- DATA LOAD & TABLE ---
    const user = JSON.parse(localStorage.getItem('user') || '{}');
    if (!user || !user._id) window.location = 'login.html';

    function getSemesterLabel(sm) {
      // Ganjil/Genap
      if (!sm) return '';
      return sm.parity === '1' ? 'Ganjil' : (sm.parity === '2' ? 'Genap' : '');
    }

    function renderArsip(semesterList, matkulList, sesiList) {
      const root = document.getElementById('arsipRoot');
      if (!semesterList || semesterList.length === 0) {
        root.innerHTML = "<div style='text-align:center; padding:30px;'>Tidak ada data semester ditemukan.</div>";
        return;
      }
      root.innerHTML = semesterList.map(sem => {
        // Mata kuliah semester ini
        const mkList = matkulList.filter(mk => mk.semester == sem.semester);
        // Buat per baris MK & sesi
        let rows = "";
        mkList.forEach(mk => {
          // Sesi
          const sesiMK = sesiList.filter(ss => ss.matkulId === mk._id);
          if (sesiMK.length === 0) {
            rows += `<tr><td>${mk.nama}</td><td colspan="6" style="text-align:center;color:#aaa;">Belum ada sesi</td></tr>`;
          } else {
            sesiMK.forEach((ss, idx) => {
              // Dokumen: list judul
              let dokList = "";
              if (ss.pdf && ss.pdf.length) {
                dokList = ss.pdf.map((file, i) => {
                  const isPdf = file.toLowerCase().endsWith(".pdf");
                  const isImg = file.match(/\.(jpg|jpeg|png|gif)$/i);
                  let viewBtn = "";
                  if (isPdf) {
                    viewBtn = `<button class="min-btn" onclick="showPopup('<iframe src=\\'${getFileUrl(file)}#toolbar=0\\' style=\\'width:90vw;height:80vh;border:none;\\'></iframe>')">Preview</button>`;
                  } else if (isImg) {
                    viewBtn = `<button class="min-btn" onclick="showPopup('<img src=\\'${getFileUrl(file)}\\' style=\\'max-width:95vw;max-height:80vh;\\' />')">Preview</button>`;
                  } else {
                    viewBtn = `<a href="${getFileUrl(file)}" target="_blank" download><button class="min-btn">Download</button></a>`;
                  }
                  return `<div style="margin-bottom:4px">${ss.pdfJudul?.[i]||'Dokumen'} ${viewBtn}</div>`;
                }).join('');
              } else {
                dokList = "-";
              }
              // Note/Link
              let linkList = "-";
              if (ss.videoLink && ss.videoLink.length) {
                linkList = ss.videoLink.map((lk, i) =>
                  `<div style="margin-bottom:4px">${ss.videoJudul?.[i]||'Note/Link'}: <a href="${lk}" target="_blank">${lk}</a></div>`
                ).join('');
              }
              rows += `
              <tr>
                ${idx===0?`<td rowspan="${sesiMK.length}" style="vertical-align:middle">${mk.nama}</td>`:""}
                <td>${idx+1}</td>
                <td>${ss.pelajaran || "-"}</td>
                <td>${ss.ringkasan || "-"}</td>
                <td>${dokList}</td>
                <td>${linkList}</td>
                <td>${ss.nilai || "-"}</td>
              </tr>`;
            });
          }
        });
        if (!rows) rows = "<tr><td colspan='7' style='text-align:center;color:#aaa;'>Belum ada mata kuliah</td></tr>";

        return `
        <div class="semester-box">
          <div class="sem-header" onclick="toggleTable('table-sem-${sem.semester}')">
            SEMESTER ${sem.semester} (${sem.tahun||''} ${getSemesterLabel(sem)}) 
            <span id="toggle-sem-${sem.semester}">[-]</span>
          </div>
          <div class="table-container" id="table-sem-${sem.semester}">
            <table>
              <thead>
                <tr>
                  <th>Mata Kuliah</th>
                  <th>Sesi</th>
                  <th>Subject</th>
                  <th>Ringkasan</th>
                  <th>Dokumen</th>
                  <th>Note / Link</th>
                  <th>Nilai</th>
                </tr>
              </thead>
              <tbody>
                ${rows}
              </tbody>
            </table>
          </div>
        </div>`;
      }).join('');
    }

    // File URL helper
    function getFileUrl(p) {
      if (!p) return "";
      if (p.startsWith("http")) return p;
      return "https://ediska-backend.onrender.com/"+p.replace(/^\/*/,"");
    }

    // Toggle collapse
    function toggleTable(id) {
      const box = document.getElementById(id);
      const btn = document.getElementById("toggle-"+id.replace('table-',''));
      if (box.style.display === "none") {
        box.style.display = "block";
        btn.innerText = "[-]";
      } else {
        box.style.display = "none";
        btn.innerText = "[+]";
      }
    }

    // --- DATA LOADING ALL ---
    async function loadAll() {
      // Load Semester
      let semRes = await fetch(`https://ediska-backend.onrender.com/api/semester/${user._id}`);
      let semesterList = await semRes.json();

      // Load MK
      let mkRes = await fetch(`https://ediska-backend.onrender.com/api/matakuliah?userId=${user._id}`);
      let matkulList = await mkRes.json();

      // Load Semua sesi
      let allSesi = [];
      for (const mk of matkulList) {
        let sesiRes = await fetch(`https://ediska-backend.onrender.com/api/matakuliah/${mk._id}/sesi`);
        let sesiList = await sesiRes.json();
        sesiList.forEach(ss => ss.matkulId = mk._id); // attach
        allSesi.push(...sesiList);
      }

      renderArsip(semesterList, matkulList, allSesi);
    }

    document.addEventListener("DOMContentLoaded", loadAll);
  </script>
</body>
</html>