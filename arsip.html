<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ARSIP AKADEMIK</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;400&display=swap" rel="stylesheet">
  <style>
    body { background: #f3f6fa; font-family: 'Montserrat', sans-serif; margin:0; padding:0; }
    h2 { color: #2597de; background: #e5f1fc; padding: 24px; border-radius: 18px; margin:0 0 26px 0; font-size: 2rem; text-align: center;}
    .semester-box { margin-bottom: 28px; border-radius: 12px; background: #fff; box-shadow: 0 4px 16px rgba(50,100,160,0.09);}
    .sem-header { background: #2597de; color: #fff; padding: 18px 14px; font-size: 1.2rem; border-radius: 12px 12px 0 0; font-weight: 600; display: flex; align-items: center; justify-content: space-between;}
    .sem-header button { background: none; border: none; color: #fff; font-size: 1.2rem; font-weight: 700; cursor: pointer;}
    .sem-content { overflow-x:auto; transition: max-height .3s; background: #fafdff; border-radius: 0 0 12px 12px;}
    table { width: 100%; border-collapse: collapse; background: #fff; }
    th, td { padding: 11px 7px; text-align: center; }
    th { background: #f2f9fd; color: #2597de; font-weight: 700;}
    td { border-bottom: 1px solid #f0f1f3; font-size: 1rem; background: #fff; }
    tr:last-child td { border-bottom: none; }
    .btn-preview { color: #2597de; text-decoration: underline; cursor: pointer; font-weight: 500; background: none; border: none; padding: 0; }
    .popup-bg { display: none; position:fixed; z-index:9999; top:0;left:0;right:0;bottom:0; background:rgba(0,0,0,0.36);}
    .popup { background:#fff; border-radius:10px; max-width:95vw; max-height:90vh; padding:18px 16px; margin:40px auto; overflow:auto; box-shadow:0 12px 32px rgba(30,60,140,0.13);}
    @media (max-width:700px) {
      th, td { font-size: 0.93rem; padding: 7px 4px; }
      h2 { font-size: 1.2rem; padding: 12px;}
    }
  </style>
</head>
<body>
  <h2>ARSIP AKADEMIK</h2>
  <div id="arsipContainer"></div>
  
  <!-- Modal for preview -->
  <div class="popup-bg" id="popupBg" onclick="closePopup(event)">
    <div class="popup" id="popupContent"></div>
  </div>

  <footer style="position:fixed;bottom:0;width:100vw;background:#fff;box-shadow:0 -1px 7px rgba(0,0,0,0.09);display:flex;justify-content:space-around;padding:10px 0;z-index:999;">
    <a href="dashboard.html" style="color:#2597de;text-align:center;">üè†<br>Beranda</a>
    <a href="semester.html" style="color:#2597de;text-align:center;">üéì<br>Semester</a>
    <a href="arsip.html" style="color:#2597de;text-align:center;">üìö<br>Arsip</a>
    <a href="profil.html" style="color:#2597de;text-align:center;">üë§<br>Profil</a>
    <a href="login.html" onclick="localStorage.clear()" style="color:#de5959;text-align:center;">üìã<br>Logout</a>
  </footer>
  
<script>
const user = JSON.parse(localStorage.getItem('user'));
if (!user || !user._id) window.location = 'login.html';

// List dokumen yang bisa di-preview (pdf/gambar)
function previewFile(filePath) {
  const ext = filePath.split('.').pop().toLowerCase();
  let konten = '';
  let fullUrl = filePath.startsWith('uploads/') || filePath.startsWith('/uploads/') ?
    'https://ediska-backend.onrender.com/' + filePath.replace(/^\/?uploads\//, 'uploads/') : filePath;
  if (['pdf'].includes(ext)) {
    konten = `<iframe src="${fullUrl}#toolbar=0" style="width:94vw;max-width:720px;height:75vh;border:none;"></iframe>`;
  } else if (['jpg','jpeg','png','gif','bmp','webp'].includes(ext)) {
    konten = `<img src="${fullUrl}" style="max-width:92vw;max-height:74vh;border-radius:8px;" />`;
  } else {
    konten = `<a href="${fullUrl}" download>Download file</a>`;
  }
  document.getElementById('popupContent').innerHTML = konten + `<br><button onclick="closePopup(event)" style="margin-top:16px;background:#2597de;color:#fff;padding:7px 16px;border:none;border-radius:7px;">Tutup</button>`;
  document.getElementById('popupBg').style.display = 'block';
}
function closePopup(e) {
  if (e && (e.target === document.getElementById('popupBg') || e.target.tagName === 'BUTTON')) {
    document.getElementById('popupBg').style.display = 'none';
    document.getElementById('popupContent').innerHTML = '';
  }
}

// Expand/collapse semester
function toggleSemContent(idx) {
  const elem = document.getElementById('sem-content-'+idx);
  const btn = document.getElementById('sem-btn-'+idx);
  if (elem.style.display==='none') {
    elem.style.display='block'; btn.innerText='[-]';
  } else {
    elem.style.display='none'; btn.innerText='[+]';
  }
}

async function fetchAll() {
  // Step 1: Get all semesters for user (dapatkan urut, include tahun/parity)
  const semRes = await fetch(`https://ediska-backend.onrender.com/api/semester/${user._id}`);
  let semesterList = await semRes.json();
  semesterList = semesterList.sort((a,b) => a.semester-b.semester);

  // Step 2: Get semua matkul di semua semester user
  const mkRes = await fetch(`https://ediska-backend.onrender.com/api/matakuliah?userId=${user._id}`);
  const mkListAll = await mkRes.json();

  // Step 3: Buat container semester
  let html = '';
  let semIdx = 0;
  for (const sem of semesterList) {
    const mkList = mkListAll.filter(mk => String(mk.semester) === String(sem.semester));
    // Cari parity/ganjil-genap, tahun (opsional)
    const tahunLabel = sem.tahun || '-';
    const parityLabel = sem.parity === '1' ? 'Ganjil' : (sem.parity === '2' ? 'Genap' : '-');
    // Table head
    html += `<div class="semester-box">
      <div class="sem-header">
        SEMESTER ${sem.semester} (${tahunLabel} ${parityLabel})
        <button id="sem-btn-${semIdx}" onclick="toggleSemContent(${semIdx})">[-]</button>
      </div>
      <div class="sem-content" id="sem-content-${semIdx}" style="display:block">
      <table>
        <thead>
          <tr>
            <th>Mata Kuliah</th>
            <th>Kode</th>
            <th>SKS</th>
            <th>Sesi</th>
            <th>Subject</th>
            <th>Ringkasan</th>
            <th>Dokumen 1</th>
            <th>Dokumen 2</th>
            <th>Dokumen 3</th>
            <th>Note/Link</th>
            <th>Nilai</th>
          </tr>
        </thead>
        <tbody>`;
    // Step 4: Tampilkan setiap matkul dan semua sesi di semester ini
    for (const mk of mkList) {
      // fetch sesi untuk matkul ini
      const sesiRes = await fetch(`https://ediska-backend.onrender.com/api/matakuliah/${mk._id}/sesi`);
      const sesiList = await sesiRes.json();
      for (const sesi of sesiList) {
        html += `<tr>
          <td>${mk.nama}</td>
          <td>${mk.kode}</td>
          <td>${mk.sks}</td>
          <td>${sesi.pelajaran ? sesi.pelajaran.split('-')[0].trim() : '-'}</td>
          <td>${sesi.pelajaran ? sesi.pelajaran.split('-').slice(1).join('-').trim() : '-'}</td>
          <td>${sesi.ringkasan || '-'}</td>
          ${[0,1,2].map(i => sesi.pdf && sesi.pdf[i] ?
            `<td>
              <button class="btn-preview" onclick="previewFile('${sesi.pdf[i]}')">
                <img src="https://cdn-icons-png.flaticon.com/512/337/337946.png" alt="" style="width:22px;vertical-align:middle;margin-right:2px;"/>Preview
              </button>
            </td>`
            : '<td>-</td>').join('')}
          <td>${
            sesi.videoLink && sesi.videoLink[0] ?
            `<a href="${sesi.videoLink[0]}" target="_blank">${sesi.videoJudul && sesi.videoJudul[0] ? sesi.videoJudul[0] : 'Link'}</a>` : '-'}</td>
          <td>${sesi.nilai || '-'}</td>
        </tr>`;
      }
    }
    html += `</tbody></table></div></div>`;
    semIdx++;
  }
  document.getElementById('arsipContainer').innerHTML = html || `<div style="text-align:center"><i>Belum ada data arsip.</i></div>`;
}
document.addEventListener('DOMContentLoaded', fetchAll);
</script>
</body>
</html>