<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ARSIP AKADEMIK</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background: #f5f7fa;
      margin: 0;
      padding: 0 0 90px 0;
    }
    h1 {
      text-align: center;
      background: #3498db;
      color: #fff;
      margin: 0;
      padding: 30px 0 16px 0;
      letter-spacing: 1px;
      font-size: 2.2rem;
      font-weight: bold;
    }
    .semester-section {
      margin: 28px 2vw 0 2vw;
      border-radius: 14px;
      box-shadow: 0 2px 12px rgba(50,100,150,0.08);
      background: #fff;
      overflow: hidden;
    }
    .semester-header {
      background: #2883c6;
      color: #fff;
      font-size: 1.22rem;
      padding: 15px 18px;
      font-weight: bold;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .semester-header span {
      margin-left: 6px;
      font-weight: normal;
      font-size: 1rem;
    }
    .semester-table {
      width: 100%;
      border-collapse: collapse;
      background: #f8fbfd;
      font-size: 1rem;
    }
    .semester-table th, .semester-table td {
      border: 1px solid #dde4ed;
      padding: 8px 7px;
      vertical-align: middle;
      text-align: center;
    }
    .semester-table th {
      background: #eaf4fb;
      font-weight: bold;
      color: #0e4369;
      font-size: 1.01rem;
    }
    .minimize-btn {
      font-size: 1.2rem;
      color: #fff;
      background: transparent;
      border: none;
      cursor: pointer;
      margin-left: 7px;
      font-weight: bold;
      outline: none;
    }
    .file-btn, .link-btn {
      background: #3498db;
      color: #fff;
      border: none;
      padding: 2px 14px;
      margin: 2px 0 2px 0;
      border-radius: 7px;
      font-size: 0.97rem;
      cursor: pointer;
      transition: background 0.13s;
    }
    .file-btn:hover, .link-btn:hover {
      background: #216397;
    }
    .file-list, .link-list {
      list-style: none;
      padding: 0;
      margin: 0;
      text-align: left;
    }
    .popup-bg {
      position: fixed; top:0; left:0; width:100vw; height:100vh; z-index:9999;
      background: rgba(34,54,90,0.25);
      display: flex; align-items: center; justify-content: center;
    }
    .popup-content {
      background: #fff;
      padding: 24px 20px 10px 20px;
      border-radius: 13px;
      box-shadow: 0 10px 32px rgba(80,80,120,0.13);
      max-width: 94vw; max-height: 92vh;
      overflow: auto;
      position: relative;
      text-align: center;
    }
    .close-btn {
      position: absolute; right: 18px; top: 14px;
      font-size: 1.5rem; color: #444; background: none;
      border: none; cursor: pointer; z-index:1;
    }
    @media (max-width: 800px) {
      .semester-section { margin:18px 0.5vw; }
      .semester-header { font-size: 1rem; padding:10px 8px; }
      .semester-table th, .semester-table td { font-size:0.95rem; padding: 7px 3px;}
      h1 { font-size:1.3rem; padding:16px 0 10px 0;}
    }
    @media (max-width: 550px) {
      .semester-header { font-size:0.97rem;}
      .semester-table { font-size:0.87rem;}
    }
    /* Footer navbar */
    footer {
      position: fixed;
      bottom: 0;
      width: 100vw;
      background: #fff;
      box-shadow: 0 -1px 6px rgba(0,0,0,0.06);
      display: flex;
      justify-content: space-around;
      padding: 9px 0 7px 0;
      z-index: 20;
    }
    footer a {
      text-decoration: none;
      color: #3498db;
      font-size: 15px;
      font-weight: 500;
      text-align: center;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 1.5px;
    }
    footer a:hover { color: #176899; }
  </style>
</head>
<body>
  <h1>ARSIP AKADEMIK</h1>
  <div id="arsip-container"></div>

  <!-- Popup viewer -->
  <div id="popupBg" class="popup-bg" style="display:none">
    <div class="popup-content" id="popupContent">
      <button class="close-btn" onclick="closePopup()">√ó</button>
      <div id="popupFile"></div>
    </div>
  </div>

  <footer>
    <a href="dashboard.html">üè†<br>Beranda</a>
    <a href="semester.html">üéì<br>Semester</a>
    <a href="arsip.html">üìö<br>Arsip</a>
    <a href="profil.html">üë§<br>Profil</a>
    <a href="login.html" onclick="localStorage.clear()">üìã<br>Log Out</a>
  </footer>

  <script>
    // Utility untuk popup preview
    function showPopup(type, url, title = 'Preview') {
      const popupBg = document.getElementById('popupBg');
      const popupFile = document.getElementById('popupFile');
      let content = `<h3 style="margin:10px 0 20px 0;">${title}</h3>`;
      url = url.startsWith('http') ? url : `https://ediska-backend.onrender.com/${url.replace(/^\/+/, "")}`;
      if (type === "pdf") {
        content += `<iframe src="${url}#toolbar=0" width="400" height="500" style="max-width:90vw;border-radius:9px;" allowfullscreen></iframe>`;
      } else if (type === "img") {
        content += `<img src="${url}" style="max-width:92vw;max-height:68vh;border-radius:9px;" />`;
      } else {
        content += `<a href="${url}" target="_blank" download style="font-size:1.1rem;font-weight:600;">Download File</a>`;
      }
      popupFile.innerHTML = content;
      popupBg.style.display = "flex";
    }
    function closePopup() {
      document.getElementById('popupBg').style.display = "none";
      document.getElementById('popupFile').innerHTML = "";
    }

    // --- Ambil user dan fetch data ---
    const user = JSON.parse(localStorage.getItem('user') || "{}");
    if (!user._id) window.location.href = "login.html";

    let semesterData = [];
    let mkData = [];
    let sesiData = {};

    async function fetchAllData() {
      // Semester
      semesterData = await fetch(`https://ediska-backend.onrender.com/api/semester/${user._id}`).then(r => r.json());
      // Matkul
      mkData = await fetch(`https://ediska-backend.onrender.com/api/matakuliah?userId=${user._id}`).then(r => r.json());
      // Sesi
      sesiData = {};
      for (const mk of mkData) {
        const sesiList = await fetch(`https://ediska-backend.onrender.com/api/matakuliah/${mk._id}/sesi`).then(r => r.json());
        sesiData[mk._id] = sesiList;
      }
      renderArsip();
    }

    // --- Rendering tabel arsip ---
    function renderArsip() {
      const container = document.getElementById('arsip-container');
      if (!semesterData.length) {
        container.innerHTML = '<div style="padding:30px;text-align:center;color:#888;">Tidak ada data semester</div>';
        return;
      }
      // Sort semester ASC
      semesterData.sort((a,b) => parseInt(a.semester)-parseInt(b.semester));

      let html = "";
      for (const sem of semesterData) {
        // Filter MK di semester ini
        const mkList = mkData.filter(mk => String(mk.semester) === String(sem.semester));
        let isMinimized = false;
        html += `
        <div class="semester-section" id="sem-section-${sem.semester}">
          <div class="semester-header" onclick="toggleSemester(${sem.semester})">
            SEMESTER ${sem.semester} (${sem.tahunSemester||''} ${sem.parity==1?'Ganjil':'Genap'}) 
            <button class="minimize-btn" id="min-btn-${sem.semester}">[-]</button>
          </div>
          <div class="semester-body" id="sem-body-${sem.semester}">
          <div style="overflow-x:auto">
            <table class="semester-table">
              <thead>
                <tr>
                  <th>Mata Kuliah</th>
                  <th>Kode MK</th>
                  <th>SKS</th>
                  <th>Sesi</th>
                  <th>Subject</th>
                  <th>Ringkasan</th>
                  <th>Dokumen</th>
                  <th>Note / Link</th>
                  <th>Nilai</th>
                </tr>
              </thead>
              <tbody>
        `;
        for (const mk of mkList) {
          const sesiList = sesiData[mk._id] || [];
          for (let i = 0; i < sesiList.length; i++) {
            const s = sesiList[i];
            // Dokumen
            let dokumenHTML = '';
            if (Array.isArray(s.pdf) && s.pdf.length) {
              dokumenHTML += '<ul class="file-list">';
              s.pdf.forEach((file, idx) => {
                const judul = s.pdfJudul?.[idx] || `Dokumen ${idx+1}`;
                const ext = (file.split('.').pop() || '').toLowerCase();
                if (["pdf"].includes(ext)) {
                  dokumenHTML += `<li><button class="file-btn" onclick="showPopup('pdf','${file}','${judul}')">${judul}</button></li>`;
                } else if (["jpg","jpeg","png","gif","bmp"].includes(ext)) {
                  dokumenHTML += `<li><button class="file-btn" onclick="showPopup('img','${file}','${judul}')">${judul}</button></li>`;
                } else {
                  dokumenHTML += `<li><a class="file-btn" href="https://ediska-backend.onrender.com/${file.replace(/^\/+/,'')}" download target="_blank">${judul}</a></li>`;
                }
              });
              dokumenHTML += '</ul>';
            }
            // Note / Link
            let noteHTML = '';
            if (Array.isArray(s.videoLink) && s.videoLink.length) {
              noteHTML += '<ul class="link-list">';
              s.videoLink.forEach((link, idx) => {
                const judul = s.videoJudul?.[idx] || `Note/Link ${idx+1}`;
                if (link.match(/^https?:\/\//)) {
                  noteHTML += `<li><a class="link-btn" href="${link}" target="_blank">${judul}</a></li>`;
                } else {
                  noteHTML += `<li><span class="link-btn" style="background:#e1ecf6;color:#333">${judul}: ${link}</span></li>`;
                }
              });
              noteHTML += '</ul>';
            }

            html += `<tr>`;
            if (i === 0) {
              html += `
                <td rowspan="${sesiList.length}">${mk.nama}</td>
                <td rowspan="${sesiList.length}">${mk.kode}</td>
                <td rowspan="${sesiList.length}">${mk.sks}</td>
              `;
            }
            html += `
              <td>${i+1}</td>
              <td>${s.pelajaran || '-'}</td>
              <td>${s.ringkasan ? s.ringkasan.replace(/</g,"&lt;").replace(/>/g,"&gt;") : '-'}</td>
              <td>${dokumenHTML || '-'}</td>
              <td>${noteHTML || '-'}</td>
              <td>${s.nilai || '-'}</td>
            </tr>`;
          }
        }
        html += `</tbody></table></div></div></div>`;
      }
      container.innerHTML = html;
    }

    // Minimize/expand semester
    function toggleSemester(sem) {
      const body = document.getElementById('sem-body-' + sem);
      const btn = document.getElementById('min-btn-' + sem);
      if (body.style.display === "none") {
        body.style.display = "block";
        btn.textContent = "[-]";
      } else {
        body.style.display = "none";
        btn.textContent = "[+]";
      }
    }

    window.showPopup = showPopup;
    window.closePopup = closePopup;
    window.toggleSemester = toggleSemester;

    // --- Init load ---
    document.addEventListener('DOMContentLoaded', fetchAllData);
  </script>
</body>
</html>