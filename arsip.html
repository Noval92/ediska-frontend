<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Arsip Akademik</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f7fafd;
      margin: 0; padding: 0 0 80px 0;
      color: #233;
    }
    .container {
      max-width: 95%;
      margin: 1.5rem auto;
      background: #fff;
      border-radius: 12px;
      padding: 1.5rem;
      box-shadow: 0 2px 20px 0 #e5eaf3;
    }
    h2 {
      background: #3498db;
      color: #fff;
      text-align: center;
      border-radius: 10px 10px 0 0;
      margin-top: 0; margin-bottom: 1.5rem;
      padding: 1.1rem;
      font-size: 1.3rem;
      letter-spacing: 2px;
    }
    .rekap-semester {
      margin-bottom: 35px;
      padding-bottom: 10px;
      border-bottom: 1px solid #eee;
    }
    .rekap-semester:last-child { border-bottom: none; }
    .matkul-box {
      background: #f6fbff;
      border-radius: 8px;
      padding: 1rem;
      margin: 1rem 0;
      box-shadow: 0 2px 6px 0 #e9eef4;
    }
    .matkul-title { font-weight: bold; font-size: 1.07rem; color: #1661aa; }
    .sesi-box {
      background: #f8f8ff;
      border-radius: 7px;
      padding: 0.8rem;
      margin: 10px 0 0 0;
      border-left: 4px solid #3498db;
    }
    .dokumen-list, .video-list {
      padding-left: 25px;
      margin-top: 0.4rem;
      font-size: 0.99rem;
    }
    .dokumen-list li, .video-list li { margin-bottom: 6px; }
    .btn-preview {
      background: #3498db;
      color: white;
      border: none;
      padding: 4px 12px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 0.95em;
      margin-right: 5px;
    }
    .pdf-preview-container iframe,
    .pdf-preview-container img {
      width: 100%;
      height: 420px;
      border: 1px solid #d2d8e0;
      border-radius: 8px;
      margin-top: 10px;
      background: #fafbff;
      object-fit: contain;
    }
    .pdf-preview-container { margin-bottom: 20px; }
    @media (max-width:600px) {
      .container { padding: 7px; }
      .pdf-preview-container iframe,
      .pdf-preview-container img { height: 260px; }
    }
    footer {
      position:fixed;bottom:0;width:100%;background:#fff;box-shadow:0 -1px 6px rgba(0,0,0,0.07);display:flex;justify-content:space-around;padding:12px 0;z-index:1000;
    }
    footer a {
      color: #2c3e50;
      text-decoration: none;
      text-align: center;
      font-size: 15px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>ARSIP AKADEMIK</h2>
    <div id="rekapAll"></div>
  </div>

  <footer>
    <a href="dashboard.html">üè†<br>Beranda</a>
    <a href="semester.html">üéì<br>Semester</a>
    <a href="arsip.html">üìö<br>Arsip</a>
    <a href="profil.html">üë§<br>Profil</a>
    <a href="login.html" onclick="localStorage.clear()">üö™<br>Logout</a>
  </footer>

<script>
const user = JSON.parse(localStorage.getItem('user'));
if (!user || !user._id) location.href = "login.html";

const BASE_URL = "https://ediska-backend.onrender.com/";

function makeFileUrl(path) {
  if (!path) return '';
  if (path.startsWith('http')) return path;
  if (path.startsWith('/')) path = path.slice(1);
  return BASE_URL + path;
}

function previewPDF(filePath, containerId) {
  const container = document.getElementById(containerId);
  if (!container) return;
  const fullPath = makeFileUrl(filePath);

  if (container.innerHTML === '') {
    if (filePath.match(/\.(jpg|jpeg|png|gif|bmp)$/i)) {
      container.innerHTML = `<img src="${fullPath}" style="max-width:100%; border-radius:6px;" />`;
    } else if (filePath.endsWith('.pdf')) {
      container.innerHTML = `<iframe src="${fullPath}#toolbar=0" allowfullscreen style="width:100%;height:420px;border-radius:8px;"></iframe>`;
    } else {
      container.innerHTML = `<a href="${fullPath}" target="_blank">Download File</a>`;
    }
    container.style.display = 'block';
  } else {
    container.innerHTML = '';
    container.style.display = 'none';
  }
}

async function loadArsip() {
  // get all semester
  const semesterRes = await fetch(`${BASE_URL}api/semester/${user._id}`);
  const semesterList = await semesterRes.json();

  let output = '';
  for (const sem of semesterList) {
    // skip semester tanpa matkul
    const matkulRes = await fetch(`${BASE_URL}api/matakuliah?userId=${user._id}&semester=${sem.semester}`);
    const matkulList = await matkulRes.json();
    if (!matkulList.length) continue;

    output += `<div class="rekap-semester">
      <div style="font-weight:bold;font-size:1.07em;margin-bottom:6px;">SEMESTER ${sem.semester} (${sem.tahun || ''} ${sem.parity==1?'Ganjil':'Genap'}) &mdash; Total SKS: ${sem.sks}</div>
    `;

    for (const m of matkulList) {
      output += `<div class="matkul-box">
        <div class="matkul-title">${m.nama} (${m.kode}) - ${m.sks} SKS</div>
      `;

      // SESI
      const sesiRes = await fetch(`${BASE_URL}api/matakuliah/${m._id}/sesi`);
      const sesiList = await sesiRes.json();
      if (!sesiList.length) {
        output += `<div style="color:#888;font-size:0.97em;">Belum ada sesi.</div>`;
      } else {
        sesiList.forEach((s, i) => {
          // dokumen & note
          const dokumenList = (s.pdf || []).map((p, idx) => {
            const judul = s.pdfJudul?.[idx] || 'Tanpa Judul';
            return `
              <li>
                ${judul}
                <button class="btn-preview" onclick="previewPDF('${p}','dokumen-preview-${s._id}-${idx}')">Preview</button>
                <div id="dokumen-preview-${s._id}-${idx}" class="pdf-preview-container" style="display:none;"></div>
              </li>
            `;
          }).join('');

          const noteList = (s.videoLink || []).map((v, idx) => {
            const judul = s.videoJudul?.[idx] || 'Note/Link';
            return `<li>${judul}: <a href="${v}" target="_blank">${v}</a></li>`;
          }).join('');

          output += `
          <div class="sesi-box">
            <div style="font-weight:600;">Sesi ${i+1}: ${s.pelajaran}</div>
            ${s.ringkasan ? `<div style="margin:6px 0;color:#445;"><em>${s.ringkasan}</em></div>` : ''}
            ${dokumenList ? `<div><b>Dokumen:</b><ul class="dokumen-list">${dokumenList}</ul></div>` : ''}
            ${noteList ? `<div><b>Note/Link:</b><ul class="video-list">${noteList}</ul></div>` : ''}
            ${s.nilai ? `<div style="margin-top:5px">Nilai: <b>${s.nilai}</b></div>` : ''}
          </div>
          `;
        });
      }
      output += `</div>`;
    }
    output += `</div>`;
  }

  document.getElementById('rekapAll').innerHTML = output || '<i>Belum ada data arsip.</i>';
}

document.addEventListener('DOMContentLoaded', loadArsip);
</script>
</body>
</html>
