<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ARSIP AKADEMIK</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Poppins', sans-serif; background: #f6f9fb; margin: 0; padding: 0 0 80px 0; }
    .container { max-width: 1100px; margin: 28px auto 12px auto; background: #fff; padding: 1.2rem 2.1rem 2.1rem 2.1rem; border-radius: 18px; box-shadow: 0 4px 18px rgba(0,0,0,0.06);}
    .judul-blok { background: #3498db; color: #fff; text-align: center; font-weight: 600; font-size: 1.8em; border-radius: 12px 12px 0 0; padding: 1.4rem 0 1.1rem 0; margin-bottom: 2rem; }
    table { border-collapse: collapse; width: 100%; background: #f9f9ff;}
    th, td { border: 1px solid #cfd8dc; padding: 7px 10px; font-size: 0.97em; text-align: left; vertical-align: top; }
    th { background: #2196f3; color: #fff; font-size: 1em;}
    tr:nth-child(even) td { background: #f6fafe;}
    .collapsible {
      overflow: hidden;
      word-break: break-word;
      max-width: 340px;
    }
    .collapsible a { color: #1565c0; text-decoration: none; cursor: pointer; font-size:0.92em; }
    .collapsible a:hover { text-decoration: underline; }
    .semester-block { background: #3498db; color: #fff; font-weight: 600; padding: 13px 18px; border-radius: 9px 9px 0 0; font-size: 1.2em; margin: 22px 0 0 0;}
    .box-hide { background: #fff3e0; color: #d84315; font-size:0.99em; padding:10px 14px; border-radius:7px; text-align:center; }
    footer { position: fixed; bottom: 0; width: 100vw; background: #fff; box-shadow: 0 -2px 16px rgba(44,62,80,0.06); display: flex; justify-content: space-around; padding: 10px 0 6px 0; z-index: 200; left: 0;}
    footer a { text-decoration: none; color: #3498db; font-size: 15px; text-align: center;}
    @media (max-width: 900px) { .container { max-width: 98vw; padding: 0.7rem;} th, td { font-size: 0.95em; } }
    @media (max-width: 700px) { th, td { font-size: 0.89em; } .judul-blok { font-size:1.15em; } }
  </style>
</head>
<body>
  <div class="container">
    <div class="judul-blok">ARSIP AKADEMIK</div>
    <div id="arsip-list"></div>
  </div>
  <footer>
    <a href="dashboard.html">üè†<br>Dashboard</a>
    <a href="arsip.html">üìö<br>Arsip</a>
    <a href="semester.html">üéì<br>Semester</a>
    <a href="login.html" onclick="localStorage.clear()">üö™<br>Logout</a>
  </footer>
  <script>
    // Collapse/expand function
    function toggleCollapse(id, ev) {
      ev.preventDefault();
      const wrap = document.getElementById(id);
      const shortEl = wrap.querySelector('.short');
      const fullEl = wrap.querySelector('.full');
      const link = wrap.querySelector('a');
      if (fullEl.style.display === 'none') {
        shortEl.style.display = 'none';
        fullEl.style.display = '';
        link.textContent = '[-]';
      } else {
        shortEl.style.display = '';
        fullEl.style.display = 'none';
        link.textContent = '[+]';
      }
    }

    const user = JSON.parse(localStorage.getItem('user'));
    if (!user || !user._id) window.location = 'login.html';

    // --- Render Arsip Akademik
    async function loadArsip() {
      // 1. Ambil data semester (riwayat)
      const resSemester = await fetch(`https://ediska-backend.onrender.com/api/semester/${user._id}`);
      const semesterList = await resSemester.json();
      // 2. Loop semester, render tabel tiap semester
      let html = '';
      for (const semester of semesterList) {
        // ambil semua matakuliah di semester tsb
        const resMatkul = await fetch(`https://ediska-backend.onrender.com/api/matakuliah?userId=${user._id}&semester=${semester.semester}`);
        const matkulList = await resMatkul.json();
        html += `
        <div class="semester-block">SEMESTER ${semester.semester} (${semester.tahunSemester ? semester.tahunSemester : ''} ${semester.ganjilGenap == 1 ? 'Ganjil' : semester.ganjilGenap == 2 ? 'Genap' : ''})</div>
        <div style="overflow-x:auto"><table>
          <thead>
            <tr>
              <th>Mata Kuliah</th>
              <th>Kode</th>
              <th>SKS</th>
              <th>Sesi</th>
              <th>Subject</th>
              <th>Ringkasan</th>
              <th>Ringkasan OCR</th>
              <th>Dokumen</th>
              <th>Note/Link</th>
              <th>Nilai</th>
            </tr>
          </thead>
          <tbody>
        `;
        for (const m of matkulList) {
          // Ambil semua sesi per matkul
          const resSesi = await fetch(`https://ediska-backend.onrender.com/api/matakuliah/${m._id}/sesi`);
          const sesiList = await resSesi.json();
          if (!sesiList.length) {
            html += `
            <tr>
              <td>${m.nama || '-'}</td>
              <td>${m.kode || '-'}</td>
              <td>${m.sks || '-'}</td>
              <td colspan="7"><div class="box-hide">Belum ada sesi</div></td>
            </tr>`;
            continue;
          }
          // Jika ada sesi, tampilkan per baris
          for (let i = 0; i < sesiList.length; i++) {
            const d = sesiList[i];
            // Format Ringkasan & OCR
            function collapseBox(text, fieldId) {
              if (!text || text === '-') return '-';
              const short = text.length > 140 ? text.slice(0, 140) + ' ...' : text;
              const id = `${fieldId}_${m._id}_${i}`;
              return text.length > 140
                ? `<div id="${id}" class="collapsible"><span class="short">${short}</span><span class="full" style="display:none">${text}</span> <a href="#" onclick="toggleCollapse('${id}', event)">[+]</a></div>`
                : `<div class="collapsible"><span class="short">${short}</span></div>`;
            }

            // Dokumen
            let dokHtml = Array.isArray(d.pdfJudul) && d.pdfJudul.length
              ? d.pdfJudul.map((j, idx) =>
                  j && d.pdf && d.pdf[idx]
                    ? `<a href="https://ediska-backend.onrender.com/${d.pdf[idx]}" target="_blank">${j}</a>`
                    : '-'
                ).filter(x=>x && x!='-').join('<br>') + `<br>${d.pdfJudul.length} dokumen`
              : '-';

            // Note/Link
            let noteHtml = Array.isArray(d.videoJudul) && d.videoJudul.length
              ? d.videoJudul.map((n, idx) =>
                  n ? (d.videoLink && d.videoLink[idx] ? `<a href="${d.videoLink[idx]}" target="_blank">${n}</a>` : n) : '-'
                ).filter(x=>x && x!='-').join('<br>')
              : '-';

            // Ringkasan OCR
            let ocrRingkasan = (d.ocrText && typeof d.ocrText === 'string' && d.ocrText.trim())
              ? collapseBox(d.ocrText, 'ocr')
              : '-';

            html += `
              <tr>
                <td>${m.nama || '-'}</td>
                <td>${m.kode || '-'}</td>
                <td>${m.sks || '-'}</td>
                <td>Sesi ${i+1}</td>
                <td>${d.pelajaran || '-'}</td>
                <td>${collapseBox(d.ringkasan || '-', 'ringkasan')}</td>
                <td>${ocrRingkasan}</td>
                <td>${dokHtml}</td>
                <td>${noteHtml}</td>
                <td>${d.nilai || '-'}</td>
              </tr>
            `;
          }
        }
        html += '</tbody></table></div>';
      }
      document.getElementById('arsip-list').innerHTML = html;
    }

    // Auto-expand/collapse CSS is already set
    window.toggleCollapse = toggleCollapse;

    // Run on load
    window.onload = loadArsip;
  </script>
</body>
</html>
